<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visitor Dashboard | Mugisha Micheal</title>
  <meta name="description" content="Visitor analytics dashboard for Mugisha Micheal portfolio." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=IBM+Plex+Serif:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header class="site-header">
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand brand" href="index.html">MUGISHA MICHEAL</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navMain">
          <ul class="navbar-nav ms-auto gap-lg-3">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="projects.html">Projects</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          </ul>
          <div class="ms-lg-4 mt-3 mt-lg-0 d-flex align-items-center gap-3">
            <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle dark or light mode">
              <span class="theme-toggle__icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="section dashboard">
    <div class="container">
      <div class="dashboard-hero">
        <div>
          <p class="eyebrow">Analytics</p>
          <h1>Visitor dashboard</h1>
          <p class="text-muted">Real-time visitor intelligence with location + device insights.</p>
        </div>
        <div class="dashboard-meta">
          <span class="dashboard-chip">Last updated: <span id="lastUpdated">--</span></span>
          <span class="dashboard-chip">Tracking: location + device</span>
        </div>
      </div>

      <div class="dashboard-kpis">
        <div class="dashboard-kpi">
          <p>Total visits</p>
          <h3 id="totalVisits">0</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Tracked pages</p>
          <h3 id="pageCount">0</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Top country</p>
          <h3 id="topCountry">--</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Top device</p>
          <h3 id="topDevice">--</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Top browser</p>
          <h3 id="topBrowser">--</h3>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>Top pages</h2>
          <div id="topPages" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Top countries</h2>
          <div id="topCountries" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Top cities</h2>
          <div id="topCities" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Device mix</h2>
          <div id="topDevices" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Operating systems</h2>
          <div id="topOS" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Browsers</h2>
          <div id="topBrowsers" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
      </div>

      <div class="dashboard-card dashboard-recent">
        <div class="dashboard-card__head">
          <h2>Recent visits</h2>
          <span class="text-muted">Last 25</span>
        </div>
        <div class="table-responsive">
          <table class="table dashboard-table align-middle">
            <thead>
              <tr>
                <th scope="col">Time</th>
                <th scope="col">Page</th>
                <th scope="col">Location</th>
                <th scope="col">Device</th>
                <th scope="col">Browser</th>
              </tr>
            </thead>
            <tbody id="recentTableBody">
              <tr>
                <td colspan="5">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-muted mb-0">Data is aggregated. IP addresses are not stored.</p>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <h3 class="footer-brand">Mugisha Micheal</h3>
        <p>Software Engineer focused on secure, scalable systems and intelligent products.</p>
        <div class="socials">
          <a href="https://github.com/Micjeal">GitHub</a>
          <a href="https://www.linkedin.com/in/mugisha-micheal">LinkedIn</a>
          <a href="https://twitter.com/mugisha_micheal">Twitter</a>
          <a href="https://wa.me/256123456789">WhatsApp</a>
        </div>
      </div>
      <div>
        <h4>Pages</h4>
        <ul class="footer-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>
      <div>
        <h4>Dashboard</h4>
        <ul class="footer-links">
          <li><a href="dashboard.html">Visitor dashboard</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <ul class="footer-links">
          <li>Email: mugishamicheal24@gmail.com</li>
          <li>Phone: +256 768 432 509</li>
          <li>Kampala, Uganda</li>
        </ul>
        <a class="btn btn-ghost mt-2" href="contact.html">Start a project</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <p>© <span id="year"></span> Mugisha Micheal. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/main.js"></script>
  <script>
    const totalVisits = document.getElementById('totalVisits');
    const pageCount = document.getElementById('pageCount');
    const topCountry = document.getElementById('topCountry');
    const topDevice = document.getElementById('topDevice');
    const topBrowser = document.getElementById('topBrowser');
    const lastUpdated = document.getElementById('lastUpdated');

    const topPages = document.getElementById('topPages');
    const topCountries = document.getElementById('topCountries');
    const topCities = document.getElementById('topCities');
    const topDevices = document.getElementById('topDevices');
    const topOS = document.getElementById('topOS');
    const topBrowsers = document.getElementById('topBrowsers');
    const recentTableBody = document.getElementById('recentTableBody');

    const escapeHtml = (value) =>
      String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const toEntries = (map) =>
      Object.entries(map || {}).filter(([, value]) => Number.isFinite(value));

    const topEntries = (map, limit) =>
      toEntries(map)
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit);

    const renderList = (container, entries) => {
      if (!entries.length) {
        container.innerHTML = '<p class="text-muted">No data yet.</p>';
        return;
      }

      const max = entries[0][1] || 1;
      container.innerHTML = entries
        .map(([label, value]) => {
          const width = `${Math.max(6, Math.round((value / max) * 100))}%`;
          return `
            <div class="metric-row">
              <div class="metric-label">${escapeHtml(label)}</div>
              <div class="metric-value">${value}</div>
              <div class="metric-bar"><span style="width: ${width};"></span></div>
            </div>
          `;
        })
        .join('');
    };

    const renderRecent = (rows) => {
      if (!rows.length) {
        recentTableBody.innerHTML = '<tr><td colspan="5">No visits yet.</td></tr>';
        return;
      }
      recentTableBody.innerHTML = rows
        .map((row) => {
          const time = row.time ? new Date(row.time).toLocaleString() : '--';
          const location = row.city && row.city !== 'Unknown'
            ? row.city
            : row.country || 'Unknown';
          return `
            <tr>
              <td>${escapeHtml(time)}</td>
              <td>${escapeHtml(row.path || '--')}</td>
              <td>${escapeHtml(location)}</td>
              <td>${escapeHtml(row.device || '--')} · ${escapeHtml(row.os || '--')}</td>
              <td>${escapeHtml(row.browser || '--')}</td>
            </tr>
          `;
        })
        .join('');
    };

    const loadStats = async () => {
      try {
        const response = await fetch('/.netlify/functions/stats');
        if (!response.ok) {
          throw new Error('Failed to fetch stats');
        }
        const data = await response.json();
        totalVisits.textContent = data.total || 0;

        const pages = data.pages || {};
        pageCount.textContent = Object.keys(pages).length;

        const topCountryEntry = topEntries(data.countries, 1)[0];
        topCountry.textContent = topCountryEntry ? `${topCountryEntry[0]} (${topCountryEntry[1]})` : '--';

        const topDeviceEntry = topEntries(data.devices, 1)[0];
        topDevice.textContent = topDeviceEntry ? `${topDeviceEntry[0]} (${topDeviceEntry[1]})` : '--';

        const topBrowserEntry = topEntries(data.browsers, 1)[0];
        topBrowser.textContent = topBrowserEntry ? `${topBrowserEntry[0]} (${topBrowserEntry[1]})` : '--';

        renderList(topPages, topEntries(pages, 6));
        renderList(topCountries, topEntries(data.countries, 6));
        renderList(topCities, topEntries(data.cities, 6));
        renderList(topDevices, topEntries(data.devices, 6));
        renderList(topOS, topEntries(data.os, 6));
        renderList(topBrowsers, topEntries(data.browsers, 6));
        renderRecent(data.recent || []);

        lastUpdated.textContent = new Date().toLocaleString();
      } catch (error) {
        topPages.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topCountries.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topCities.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topDevices.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topOS.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topBrowsers.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        recentTableBody.innerHTML = '<tr><td colspan="5">Unable to load stats.</td></tr>';
      }
    };

    loadStats();
  </script>
</body>
</html>
