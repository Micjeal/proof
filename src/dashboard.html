<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visitor Dashboard | Mugisha Micheal</title>
  <meta name="description" content="Visitor analytics dashboard for Mugisha Micheal portfolio." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=IBM+Plex+Serif:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header class="site-header">
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand brand" href="index.html">MUGISHA MICHEAL</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navMain">
          <ul class="navbar-nav ms-auto gap-lg-3">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="projects.html">Projects</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          </ul>
          <div class="ms-lg-4 mt-3 mt-lg-0 d-flex align-items-center gap-3">
            <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle dark or light mode">
              <span class="theme-toggle__icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="section dashboard">
    <div class="container">
      <div class="dashboard-hero">
        <div class="dashboard-hero__copy">
          <p class="eyebrow">Analytics</p>
          <h1>Visitor dashboard</h1>
          <p class="text-muted">Track unique visitors, referrers, landing pages, and session behavior.</p>
        </div>
        <div class="dashboard-hero__controls">
          <div class="dashboard-filters" role="group" aria-label="Date range">
            <button class="filter-btn" type="button" data-range="today">Today</button>
            <button class="filter-btn is-active" type="button" data-range="7">7 Days</button>
            <button class="filter-btn" type="button" data-range="30">30 Days</button>
            <button class="filter-btn" type="button" data-range="all">All</button>
          </div>
          <div class="dashboard-meta">
            <button class="btn btn-ghost btn-sm" id="exportCsv" type="button">Export CSV</button>
            <span class="dashboard-chip">Last updated: <span id="lastUpdated">--</span></span>
            <span class="dashboard-chip">Tracking: location + device</span>
          </div>
        </div>
      </div>

      <div class="dashboard-kpis">
        <div class="dashboard-kpi">
          <p>Total visits</p>
          <h3 id="totalVisits">0</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Unique visitors</p>
          <h3 id="uniqueVisitors">0</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Avg session</p>
          <h3 id="avgSession">0s</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Tracked pages</p>
          <h3 id="pageCount">0</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Top country</p>
          <h3 id="topCountry">--</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Top referrer</p>
          <h3 id="topReferrer">--</h3>
        </div>
        <div class="dashboard-kpi">
          <p>Top landing</p>
          <h3 id="topLanding">--</h3>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>Top pages</h2>
          <div id="topPages" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Referrers</h2>
          <div id="topReferrers" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Landing pages</h2>
          <div id="topLandings" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Top countries</h2>
          <div id="topCountries" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Top cities</h2>
          <div id="topCities" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Device mix</h2>
          <div id="topDevices" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Operating systems</h2>
          <div id="topOS" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>Browsers</h2>
          <div id="topBrowsers" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>404 errors</h2>
          <div id="topErrors" class="metric-list">
            <p class="text-muted">Loading...</p>
          </div>
        </div>
      </div>

      <div class="dashboard-card dashboard-recent">
        <div class="dashboard-card__head">
          <h2>Recent visits</h2>
          <span class="text-muted">Last 25</span>
        </div>
        <div class="table-responsive">
          <table class="table dashboard-table align-middle">
            <thead>
              <tr>
                <th scope="col">Time</th>
                <th scope="col">Page</th>
                <th scope="col">Location</th>
                <th scope="col">Referrer</th>
                <th scope="col">Device</th>
                <th scope="col">Browser</th>
              </tr>
            </thead>
            <tbody id="recentTableBody">
              <tr>
                <td colspan="6">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-muted mb-0">Data is aggregated. IPs are hashed for unique counts and never stored in raw form.</p>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <h3 class="footer-brand">Mugisha Micheal</h3>
        <p>Software Engineer focused on secure, scalable systems and intelligent products.</p>
        <div class="socials">
          <a href="https://github.com/Micjeal">GitHub</a>
          <a href="https://www.linkedin.com/in/mugisha-micheal">LinkedIn</a>
          <a href="https://twitter.com/mugisha_micheal">Twitter</a>
          <a href="https://wa.me/256123456789">WhatsApp</a>
        </div>
      </div>
      <div>
        <h4>Pages</h4>
        <ul class="footer-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>
      <div>
        <h4>Dashboard</h4>
        <ul class="footer-links">
          <li><a href="dashboard.html">Visitor dashboard</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <ul class="footer-links">
          <li>Email: mugishamicheal24@gmail.com</li>
          <li>Phone: +256 768 432 509</li>
          <li>Kampala, Uganda</li>
        </ul>
        <a class="btn btn-ghost mt-2" href="contact.html">Start a project</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <p>© <span id="year"></span> Mugisha Micheal. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/main.js"></script>
  <script>
    const totalVisits = document.getElementById('totalVisits');
    const uniqueVisitors = document.getElementById('uniqueVisitors');
    const avgSession = document.getElementById('avgSession');
    const pageCount = document.getElementById('pageCount');
    const topCountry = document.getElementById('topCountry');
    const topReferrer = document.getElementById('topReferrer');
    const topLanding = document.getElementById('topLanding');
    const lastUpdated = document.getElementById('lastUpdated');
    const exportCsvBtn = document.getElementById('exportCsv');

    const topPages = document.getElementById('topPages');
    const topReferrers = document.getElementById('topReferrers');
    const topLandings = document.getElementById('topLandings');
    const topCountries = document.getElementById('topCountries');
    const topCities = document.getElementById('topCities');
    const topDevices = document.getElementById('topDevices');
    const topOS = document.getElementById('topOS');
    const topBrowsers = document.getElementById('topBrowsers');
    const topErrors = document.getElementById('topErrors');
    const recentTableBody = document.getElementById('recentTableBody');
    const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));

    let currentRange = '7';
    let currentStats = null;

    const escapeHtml = (value) =>
      String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const csvEscape = (value) => {
      const text = String(value ?? '');
      return /[",\n]/.test(text) ? `"${text.replace(/"/g, '""')}"` : text;
    };

    const formatDuration = (seconds) => {
      const value = Math.max(0, Math.round(Number(seconds) || 0));
      const mins = Math.floor(value / 60);
      const hrs = Math.floor(mins / 60);
      const sec = value % 60;
      const min = mins % 60;
      if (hrs > 0) return `${hrs}h ${min}m`;
      if (mins > 0) return `${mins}m ${sec}s`;
      return `${sec}s`;
    };

    const toEntries = (map) =>
      Object.entries(map || {}).filter(([, value]) => Number.isFinite(value));

    const topEntries = (map, limit) =>
      toEntries(map)
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit);

    const renderList = (container, entries) => {
      if (!entries.length) {
        container.innerHTML = '<p class="text-muted">No data yet.</p>';
        return;
      }

      const max = entries[0][1] || 1;
      container.innerHTML = entries
        .map(([label, value]) => {
          const width = `${Math.max(6, Math.round((value / max) * 100))}%`;
          return `
            <div class="metric-row">
              <div class="metric-label">${escapeHtml(label)}</div>
              <div class="metric-value">${value}</div>
              <div class="metric-bar"><span style="width: ${width};"></span></div>
            </div>
          `;
        })
        .join('');
    };

    const renderRecent = (rows) => {
      if (!rows.length) {
        recentTableBody.innerHTML = '<tr><td colspan="6">No visits yet.</td></tr>';
        return;
      }
      recentTableBody.innerHTML = rows
        .map((row) => {
          const time = row.time ? new Date(row.time).toLocaleString() : '--';
          const location = row.city && row.city !== 'Unknown'
            ? row.city
            : row.country || 'Unknown';
          return `
            <tr>
              <td>${escapeHtml(time)}</td>
              <td>${escapeHtml(row.path || '--')}</td>
              <td>${escapeHtml(location)}</td>
              <td>${escapeHtml(row.referrer || 'Direct')}</td>
              <td>${escapeHtml(row.device || '--')} · ${escapeHtml(row.os || '--')}</td>
              <td>${escapeHtml(row.browser || '--')}</td>
            </tr>
          `;
        })
        .join('');
    };

    const setActiveFilter = (range) => {
      filterButtons.forEach((button) => {
        button.classList.toggle('is-active', button.dataset.range === range);
      });
    };

    const loadStats = async (range) => {
      const targetRange = range || currentRange;
      setActiveFilter(targetRange);
      currentRange = targetRange;
      try {
        const response = await fetch(`/.netlify/functions/stats?range=${encodeURIComponent(targetRange)}`);
        if (!response.ok) {
          throw new Error('Failed to fetch stats');
        }
        const data = await response.json();
        currentStats = data;
        totalVisits.textContent = data.pageviews || 0;
        uniqueVisitors.textContent = data.uniqueVisitors || 0;
        avgSession.textContent = formatDuration(data.avgSessionDuration || 0);

        const pages = data.pages || {};
        pageCount.textContent = Object.keys(pages).length;

        const topCountryEntry = topEntries(data.countries, 1)[0];
        topCountry.textContent = topCountryEntry ? `${topCountryEntry[0]} (${topCountryEntry[1]})` : '--';

        const topReferrerEntry = topEntries(data.referrers, 1)[0];
        topReferrer.textContent = topReferrerEntry ? `${topReferrerEntry[0]} (${topReferrerEntry[1]})` : '--';

        const topLandingEntry = topEntries(data.landings, 1)[0];
        topLanding.textContent = topLandingEntry ? `${topLandingEntry[0]} (${topLandingEntry[1]})` : '--';

        renderList(topPages, topEntries(pages, 6));
        renderList(topReferrers, topEntries(data.referrers, 6));
        renderList(topLandings, topEntries(data.landings, 6));
        renderList(topCountries, topEntries(data.countries, 6));
        renderList(topCities, topEntries(data.cities, 6));
        renderList(topDevices, topEntries(data.devices, 6));
        renderList(topOS, topEntries(data.os, 6));
        renderList(topBrowsers, topEntries(data.browsers, 6));
        renderList(topErrors, topEntries(data.errors404, 6));
        renderRecent(data.recent || []);

        lastUpdated.textContent = data.generatedAt ? new Date(data.generatedAt).toLocaleString() : new Date().toLocaleString();
      } catch (error) {
        topPages.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topReferrers.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topLandings.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topCountries.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topCities.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topDevices.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topOS.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topBrowsers.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        topErrors.innerHTML = '<p class="text-muted">Unable to load stats.</p>';
        recentTableBody.innerHTML = '<tr><td colspan="6">Unable to load stats.</td></tr>';
      }
    };

    const exportCsv = () => {
      if (!currentStats) {
        return;
      }

      const lines = [];
      lines.push(`Range,${csvEscape(currentRange)}`);
      lines.push(`From,${csvEscape(currentStats.rangeStart || '')}`);
      lines.push(`To,${csvEscape(currentStats.rangeEnd || '')}`);
      lines.push(`Generated,${csvEscape(currentStats.generatedAt || '')}`);
      lines.push('');
      lines.push('Metric,Value');
      lines.push(`Pageviews,${currentStats.pageviews || 0}`);
      lines.push(`Unique visitors,${currentStats.uniqueVisitors || 0}`);
      lines.push(`Avg session duration (seconds),${currentStats.avgSessionDuration || 0}`);
      lines.push(`Session count,${currentStats.sessionCount || 0}`);
      lines.push(`Tracked pages,${Object.keys(currentStats.pages || {}).length}`);
      lines.push('');

      const addSection = (title, map) => {
        lines.push(title);
        lines.push('Label,Value');
        topEntries(map, 50).forEach(([label, value]) => {
          lines.push(`${csvEscape(label)},${value}`);
        });
        lines.push('');
      };

      addSection('Top Pages', currentStats.pages);
      addSection('Referrers', currentStats.referrers);
      addSection('Landing Pages', currentStats.landings);
      addSection('Countries', currentStats.countries);
      addSection('Cities', currentStats.cities);
      addSection('Devices', currentStats.devices);
      addSection('Operating Systems', currentStats.os);
      addSection('Browsers', currentStats.browsers);
      addSection('404 Errors', currentStats.errors404);

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const dateStamp = new Date().toISOString().slice(0, 10);
      link.href = url;
      link.download = `visitor-stats-${currentRange}-${dateStamp}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => loadStats(button.dataset.range));
    });

    if (exportCsvBtn) {
      exportCsvBtn.addEventListener('click', exportCsv);
    }

    loadStats(currentRange);
  </script>
</body>
</html>
